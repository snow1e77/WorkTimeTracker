# Техническая реализация системы синхронизации WorkTime

## Обзор реализации

Система синхронизации между мобильным приложением и веб админ-панелью реализована с следующими ключевыми компонентами:

### 1. Новые типы данных (src/types/index.ts)
```typescript
// Назначение рабочих на объекты
interface UserSiteAssignment {
  id: string;
  userId: string;
  siteId: string;
  assignedBy: string;
  isActive: boolean;
  assignedAt: Date;
  validFrom?: Date;
  validTo?: Date;
  notes?: string;
}

// Метаданные синхронизации
interface SyncMetadata {
  entityType: 'user' | 'site' | 'assignment' | 'shift' | 'report';
  entityId: string;
  lastModified: Date;
  version: number;
  deviceId: string;
}

// Пакет данных синхронизации
interface SyncPayload {
  users: AuthUser[];
  sites: ConstructionSite[];
  assignments: UserSiteAssignment[];
  shifts: WorkShift[];
  reports: WorkReport[];
  metadata: {
    timestamp: Date;
    version: number;
    deviceId: string;
  };
}

// Конфликт синхронизации
interface SyncConflict {
  entityType: string;
  entityId: string;
  localVersion: any;
  remoteVersion: any;
  conflictType: 'UPDATE_CONFLICT' | 'DELETE_CONFLICT';
  resolution?: 'LOCAL_WINS' | 'REMOTE_WINS' | 'MERGE';
}
```

### 2. Сервис синхронизации для мобильного приложения (src/services/SyncService.ts)
- Управление синхронизацией данных с сервером
- Обработка конфликтов при одновременном редактировании
- Офлайн-режим с локальным кэшированием
- Автоматическая синхронизация при подключении к интернету

### 3. Сервис управления назначениями (src/services/AssignmentService.ts)
- Создание и управление назначениями рабочих на объекты
- Проверка прав доступа
- Получение списка доступных объектов для конкретного рабочего
- Валидация назначений по датам

### 4. Веб-версия базы данных (src/services/WebDatabaseService.ts)
Добавлены новые методы:
- `getAllAssignments()` - получить все назначения
- `createAssignment()` - создать новое назначение
- `updateAssignment()` - обновить назначение
- `deleteAssignment()` - удалить назначение
- `getUserAssignments()` - получить назначения пользователя
- `getSiteAssignments()` - получить назначения объекта
- `getUserAssignedSites()` - получить объекты, назначенные пользователю

### 5. Веб-сервис синхронизации (src/services/WebSyncService.ts)
- Синхронизация данных с мобильными устройствами
- Автоматическая синхронизация каждые 5 минут
- Обработка данных от мобильных устройств
- Статус синхронизации и мониторинг

### 6. Обновленная админ-панель (src/components/AdminWebPanel.tsx)
Добавлена новая вкладка "Assignments" с функционалом:
- Создание новых назначений рабочих на объекты
- Просмотр всех назначений в табличном виде
- Активация/деактивация назначений
- Удаление назначений
- Отображение информации о рабочих и объектах

## Архитектура синхронизации

```
┌─────────────────┐         ┌─────────────────┐
│  Мобильное      │◄────────┤  Веб админ-     │
│  приложение     │ Sync    │  панель         │
│                 │────────►│                 │
│ • SyncService   │         │ • WebSyncService│
│ • AssignmentSvc │         │ • WebDatabase   │
│ • SQLite        │         │ • localStorage  │
└─────────────────┘         └─────────────────┘
        │                           │
        │                           │
        ▼                           ▼
┌─────────────────┐         ┌─────────────────┐
│ Локальные       │         │ Веб хранилище   │
│ данные          │         │ (localStorage)  │
│ • Назначения    │         │ • Пользователи  │
│ • Объекты       │         │ • Объекты       │
│ • Смены         │         │ • Назначения    │
└─────────────────┘         └─────────────────┘
```

## Процесс синхронизации

### 1. Инициализация
- При запуске приложения загружаются локальные данные
- Проверяется подключение к интернету
- Запускается автоматическая синхронизация

### 2. Синхронизация назначений
1. Веб-панель создает/изменяет назначения
2. Данные сохраняются в localStorage
3. WebSyncService отправляет обновления на мобильные устройства
4. Мобильные устройства получают и применяют изменения
5. Локальные данные обновляются

### 3. Обработка конфликтов
- При одновременном изменении данных создается конфликт
- Система предлагает варианты разрешения
- Администратор может выбрать приоритетную версию
- Изменения синхронизируются на все устройства

## Особенности реализации

### Безопасность
- Рабочие видят только свои назначения
- Проверка прав доступа на уровне сервисов
- Валидация данных при синхронизации

### Производительность
- Инкрементальная синхронизация (только изменения)
- Локальное кэширование данных
- Фоновая синхронизация без блокировки UI

### Надежность
- Офлайн-режим с локальным сохранением
- Повторные попытки при сбоях сети
- Восстановление после ошибок

## Файлы изменений

### Новые файлы:
- `src/services/SyncService.ts` - мобильная синхронизация
- `src/services/AssignmentService.ts` - управление назначениями
- `src/services/WebSyncService.ts` - веб-синхронизация
- `SYNC_USAGE.md` - руководство пользователя
- `SYNC_IMPLEMENTATION.md` - техническая документация

### Измененные файлы:
- `src/types/index.ts` - новые типы данных
- `src/services/WebDatabaseService.ts` - методы для назначений
- `src/components/AdminWebPanel.tsx` - интерфейс назначений

## Демонстрационные данные

### Пользователи:
- admin-1: Admin User (администратор)
- worker-1: John Worker (рабочий)
- worker-2: Jane Worker (рабочий)

### Объекты:
- site-1: Construction Site Alpha
- site-2: Construction Site Beta

### Назначения:
- John Worker → Construction Site Alpha
- Jane Worker → Construction Site Beta

## Следующие шаги для полной реализации

1. **API сервер** - создать REST API для синхронизации
2. **Реальная база данных** - заменить localStorage на PostgreSQL/MongoDB
3. **Push уведомления** - уведомления о новых назначениях
4. **Тестирование** - unit и integration тесты
5. **Мониторинг** - логирование и метрики синхронизации
6. **Документация API** - Swagger/OpenAPI спецификация

## Заключение

Реализована базовая система синхронизации с назначением рабочих зон. Система готова для демонстрации и дальнейшего развития. Все ключевые компоненты созданы и интегрированы. 