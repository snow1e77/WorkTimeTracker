@echo off
chcp 65001 >nul
setlocal EnableDelayedExpansion

echo ========================================
echo   Work Time Tracker - –ü–æ–ª–Ω—ã–π –∑–∞–ø—É—Å–∫
echo ========================================

:: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd /d "%~dp0"

:: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Docker
set DOCKER_BUILDKIT=0
set COMPOSE_DOCKER_CLI_BUILD=0

echo.
echo [1/6] –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Docker...
docker --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå Docker –Ω–µ –Ω–∞–π–¥–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Desktop –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç.
    pause
    exit /b 1
)
echo ‚úÖ Docker –Ω–∞–π–¥–µ–Ω

echo.
echo [2/6] –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Node.js...
node --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç.
    pause
    exit /b 1
)
echo ‚úÖ Node.js –Ω–∞–π–¥–µ–Ω

echo.
echo [2.5/6] –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Docker Compose...
docker-compose --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå Docker Compose –Ω–µ –Ω–∞–π–¥–µ–Ω! –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Docker Desktop —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
    pause
    exit /b 1
)
echo ‚úÖ Docker Compose –Ω–∞–π–¥–µ–Ω

echo.
echo [3/7] –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...
if not exist "node_modules" (
    echo üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞...
    call npm install
    if errorlevel 1 (
        echo ‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
        pause
        exit /b 1
    )
)

if not exist "server\node_modules" (
    echo üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞...
    cd server
    call npm install
    cd ..
    if errorlevel 1 (
        echo ‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å–µ—Ä–≤–µ—Ä–∞
        pause
        exit /b 1
    )
)
echo ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã

echo.
echo [4/7] –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)...
docker-compose down >nul 2>&1

echo.
echo [5/7] –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —á–∞—Å—Ç—å —á–µ—Ä–µ–∑ Docker...
echo üê≥ –ó–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...
docker-compose up -d
if errorlevel 1 (
    echo ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    pause
    exit /b 1
)

echo ‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã

:: –ñ–¥–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞
echo.
echo ‚è≥ –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞...
timeout /t 10 /nobreak >nul

echo.
echo [6/7] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤...
docker-compose ps

echo.
echo [7/7] –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...

:: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è Expo
echo üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Expo –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ...
start "WorkTime Tracker - Expo" cmd /k "echo –ó–∞–ø—É—Å–∫ Expo... ; npm start"

echo.
echo ========================================
echo   ‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!
echo ========================================
echo.
echo üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
echo   ‚Ä¢ –°–µ—Ä–≤–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: http://localhost:3001
echo   ‚Ä¢ PgAdmin (–ë–î): http://localhost:5050
echo     –õ–æ–≥–∏–Ω: admin@worktime.com ^| –ü–∞—Ä–æ–ª—å: admin
echo   ‚Ä¢ PostgreSQL: localhost:5433
echo     –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: postgres ^| –ü–∞—Ä–æ–ª—å: postgres
echo.
echo üì± –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
echo   ‚Ä¢ Expo Metro –∑–∞–ø—É—â–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ
echo   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ QR –∫–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
echo   ‚Ä¢ –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ 'w' –≤ Expo –¥–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏
echo.
echo üõ†Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
echo   ‚Ä¢ –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞: docker-compose logs -f server
echo   ‚Ä¢ –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤: docker-compose logs -f
echo   ‚Ä¢ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker: docker-compose down
echo   ‚Ä¢ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å–µ—Ä–≤–µ—Ä: docker-compose up -d --build server
echo.
echo üí° –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: stop-project.bat
echo.
pause 